<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>fib</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.css" integrity="sha256-Te9+aTaL9j0U5PzLhtAHt+SXlgIT8KT9VkyOZn68hak=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.js" integrity="sha256-UzffRueYhyZDw8Cj39UCnnggvBfa1fPcDQ0auvCbvCc=" crossorigin="anonymous"></script>
  <style media="screen">
  body {
    width: 100%;
    height: 100%;
    overflow: scroll;
  }
  .ct-series-a .ct-line, .ct-series-a .ct-point {
    stroke: #F0DB4F;
  }
  .ct-series-b .ct-line, .ct-series-b .ct-point {
    stroke: #4f64f0;
  }
  </style>

  <script type="text/javascript">
  const FIB_MAX = 360;
  const BENCH_LOOP = 10;
  const USE_MEMO = true;

  function fib(n) {
    if (n <= 1) return 1;
    return fibJS(n - 1) + fibJS(n - 2);
  }

  function fib_memo(n) {
    if (n <= 1) return 1;
    let memo = [1, 1];
    for (let i = 2; i < n; i++) {
      memo[i] = memo[i - 1] + memo[i - 2];
    }
    return memo[n];
  }

  const fibJS = USE_MEMO ? fib_memo : fib;

  fetch('fib.wasm')
  .then(response => response.arrayBuffer())
  .then(buffer => WebAssembly.instantiate(buffer, {}))
  .then(({ instance: { exports: { fib, fib_memo } } }) => {
    const fibWASM = USE_MEMO ? fib_memo : fib;

    let labels = [];
    let data = [[], []];

    for (let i = 0; i < FIB_MAX; i++) {
      labels.push(i);

      let jsTime = 0.0;
      for (let loop = 0; loop < BENCH_LOOP; loop++) {
        const jsStart = performance.now();
        fibJS(i);
        const time = performance.now() - jsStart;
        jsTime += time;
        console.info(`[ JS ][${i} : ${loop}] ${time}`);
      }
      jsTime /= BENCH_LOOP;
      data[0].push(jsTime);

      let wasmTime = 0.0;
      for (let loop = 0; loop < BENCH_LOOP; loop++) {
        const wasmStart = performance.now();
        fibWASM(i);
        const time = performance.now() - wasmStart;
        console.info(`[WASM][${i} : ${loop}] ${time}`);
        wasmTime += time;
      }
      wasmTime /= BENCH_LOOP;
      data[1].push(wasmTime);

      new Chartist.Line('#chart', { labels, series: data }, {});
    }
  })
  .catch(error => console.error(error))
  </script>
</head>
<body>
  <div id="chart" class="ct-chart ct-perfect-fourth"></div>
</body>
</html>
